# Интеграция с Zabbix

## Общая схема интеграции

Проект zbx-1c-py предназначен для интеграции с системой мониторинга Zabbix и предоставляет возможность мониторинга кластеров 1С:Предприятия, сессий пользователей и фоновых заданий. Проект кроссплатформенный и работает на Windows, Linux и macOS.

## Поддерживаемые режимы работы

### 1. Low-Level Discovery (LLD)

Режим автоматического обнаружения кластеров 1С позволяет Zabbix автоматически создавать элементы данных для каждого обнаруженного кластера.

**Команда**:
```
python3 /path/to/zbx_1c_py/main.py --discovery
```

**Пример использования в Zabbix**:
- Создайте элемент данных типа "Zabbix agent" с ключом, который возвращает результат команды discovery
- Используйте полученный JSON для создания прототипов элементов данных

### 2. Сбор метрик

Для каждого кластера можно собирать следующие метрики:
- Общее количество сессий
- Количество активных сессий
- Количество активных фоновых заданий
- Статус кластера

## Настройка Zabbix Agent

### UserParameter

Добавьте следующие строки в конфигурационный файл Zabbix Agent (обычно `zabbix_agentd.conf`):

```
# Обнаружение кластеров 1С
UserParameter=1c.cluster.discovery[*],cd /path/to/zbx-1c-py && uv run python3 src/zbx_1c_py/main.py --discovery

# Проверка доступности RAS
UserParameter=1c.ras.check[*],cd /path/to/zbx-1c-py && uv run python3 src/zbx_1c_py/main.py --check-ras

# Сбор метрик для конкретного кластера
UserParameter=1c.cluster.metrics[*],cd /path/to/zbx-1c-py && uv run python3 src/zbx_1c_py/main.py $1

# Получение отдельных метрик с использованием JSONPath
UserParameter=1c.cluster.sessions.total[*],cd /path/to/zbx-1c-py && uv run python3 src/zbx_1c_py/main.py $1 | jq -r '.metrics.total_sessions'
UserParameter=1c.cluster.sessions.active[*],cd /path/to/zbx-1c-py && uv run python3 src/zbx_1c_py/main.py $1 | jq -r '.metrics.active_sessions'
UserParameter=1c.cluster.jobs.active[*],cd /path/to/zbx-1c-py && uv run python3 src/zbx_1c_py/main.py $1 | jq -r '.metrics.active_bg_jobs'
UserParameter=1c.cluster.status[*],cd /path/to/zbx-1c-py && uv run python3 src/zbx_1c_py/main.py $1 | jq -r '.metrics.status'
```

**Важно**: Замените `/path/to/zbx-1c-py` на актуальный путь к проекту в вашей системе. Учтите различия в пути между операционными системами:
- Linux/macOS: `/opt/zbx-1c-py/`
- Windows: `C:\Program Files\zbx-1c-py\`

Проект использует uv для изоляции от системного Python, что обеспечивает стабильность и воспроизводимость работы. Убедитесь, что uv установлен в системе, где работает Zabbix Agent.

## Шаблон Zabbix

### Создание шаблона

Для удобства можно создать шаблон Zabbix с преднастроенными элементами данных:

1. **Макросы шаблона**:
   - `{$CLUSTER_ID}` - идентификатор кластера (для тестирования)

2. **LLD правило**:
   - Имя: "Обнаружение кластеров 1С"
   - Тип: Zabbix agent
   - Ключ: `1c.cluster.discovery[]`
   - Тип прототипа: Text (JSON)

3. **Прототипы элементов данных**:
   - `{#CLUSTER_NAME}.sessions.total` - Общее количество сессий
     - Ключ: `1c.cluster.sessions.total[{#CLUSTER_ID}]`
     - Тип: Zabbix agent
     - Интервал обновления: 30s
     - Единицы измерения: 

   - `{#CLUSTER_NAME}.sessions.active` - Активные сессии
     - Ключ: `1c.cluster.sessions.active[{#CLUSTER_ID}]`
     - Тип: Zabbix agent
     - Интервал обновления: 30s
     - Единицы измерения: 

   - `{#CLUSTER_NAME}.jobs.active` - Активные фоновые задания
     - Ключ: `1c.cluster.jobs.active[{#CLUSTER_ID}]`
     - Тип: Zabbix agent
     - Интервал обновления: 30s
     - Единицы измерения: 

   - `{#CLUSTER_NAME}.status` - Статус кластера
     - Ключ: `1c.cluster.status[{#CLUSTER_ID}]`
     - Тип: Zabbix agent
     - Интервал обновления: 1m
     - Тип данных: Boolean

## Использование JSONPath

Поскольку скрипт возвращает структурированные JSON-данные, вы можете использовать JSONPath для извлечения отдельных значений:

**Примеры JSONPath выражений**:
- `.cluster_id` - идентификатор кластера
- `.cluster_name` - имя кластера
- `.metrics.total_sessions` - общее количество сессий
- `.metrics.active_sessions` - активные сессии
- `.metrics.active_bg_jobs` - активные фоновые задания
- `.metrics.status` - статус кластера

## Кроссплатформенные особенности

### Пути к исполняемым файлам
- **Linux**: `/opt/1C/v8.3/x.x.x.x/rac` (где x.x.x.x - номер версии)
- **Windows**: `C:/Program Files/1cv8/x.x.x.x/rac.exe`
- **macOS**: `/Applications/1C/Enterprise Platform/x.x.x.x/rac`

### Настройка в Zabbix Agent
При настройке UserParameter учитывайте различия в операционных системах:
- В Windows может потребоваться указание полного пути к интерпретатору Python
- В Linux/macOS могут отличаться права доступа к файлам

### Кодировка
Проект учитывает различия в кодировке между операционными системами:
- Windows: по умолчанию используется CP866 для 1С
- Linux/macOS: обычно UTF-8
- Проект автоматически обрабатывает различия в кодировке

## Рекомендации по настройке

### Интервалы обновления
- Для метрик сессий и заданий: 30-60 секунд
- Для статуса кластера: 1-5 минут
- Для LLD: 10-30 минут (в зависимости от частоты изменений)

### Триггеры
Примеры триггеров, которые можно создать:
- "Количество активных сессий превышает порог" (например, > 50)
- "Количество активных фоновых заданий превышает порог" (например, > 10)
- "Кластер недоступен" (статус = 0)

### Графики
Можно создать графики для визуализации:
- Динамики количества сессий
- Активности фоновых заданий
- Сравнения нагрузки между кластерами

## Устранение неполадок

### Проверка работоспособности
1. Проверьте, что скрипт запускается вручную:
   ```bash
   python3 /path/to/zbx_1c_py/main.py --discovery
   ```

2. Убедитесь, что Zabbix Agent может выполнить команду:
   ```bash
   sudo -u zabbix zabbix_agentd -t "1c.cluster.discovery[]"
   ```

3. Проверьте права доступа к файлам и каталогам

### Кроссплатформенные проблемы
- **Windows**: Убедитесь, что путь к rac.exe указан с правильными разделителями (`\` или `/`)
- **Linux**: Проверьте права доступа к исполняемым файлам 1С
- **macOS**: Убедитесь, что 1С правильно установлена и доступна в PATH

### Распространенные проблемы
- Ошибка доступа к rac.exe - проверьте права пользователя zabbix
- Неверный путь к скрипту - убедитесь, что путь указан правильно для конкретной ОС
- Проблемы с сетью - проверьте доступность RAS-сервиса
- Проблемы с кодировкой - убедитесь, что используется UTF-8

## Безопасность

- Убедитесь, что учетные данные для доступа к кластеру 1С защищены
- Ограничьте права доступа к файлу конфигурации
- Регулярно обновляйте зависимости проекта
- Используйте изолированную среду выполнения (virtual environment)
- Учитывайте различия в системах безопасности между операционными системами