# Безопасность

## Обзор вопросов безопасности

Проект zbx-1c-py учитывает важные аспекты безопасности при интеграции с системой мониторинга Zabbix и взаимодействии с сервером 1С:Предприятия. Проект кроссплатформенный и работает на Windows, Linux и macOS, поэтому учитываются особенности безопасности для каждой операционной системы.

## Управление секретами

### Хранение учетных данных
- Учетные данные для доступа к кластеру 1С должны храниться в файле `.env`
- Не храните учетные данные в коде или в системе контроля версий
- Используйте права доступа к файлу для ограничения доступа

### Пример безопасного файла .env
```env
# Учетные данные для доступа к кластеру 1С
USER_NAME=zbx_monitoring_user
USER_PASS=strong_password_here
```

### Права доступа к файлам
Установите соответствующие права доступа к конфигурационным файлам:

**Linux/macOS**:
```bash
chmod 600 .env
chmod 600 config/
```

**Windows**:
- Используйте права доступа NTFS для ограничения доступа к файлам
- Убедитесь, что только необходимые пользователи имеют доступ к файлу .env
- Используйте шифрование EFS при необходимости

## Проверка уязвимостей

### Регулярная проверка зависимостей
```bash
uv run pip-audit
```

Эта команда проверяет установленные пакеты на наличие известных уязвимостей.

### Обновление зависимостей
Регулярно обновляйте зависимости для получения исправлений безопасности:
```bash
uv sync --upgrade
```

## Безопасность выполнения команд

### Валидация входных данных
Проект включает проверки для предотвращения внедрения команд:
- Проверка идентификаторов кластеров
- Санитизация параметров командной строки
- Ограничение на длину и формат входных данных

### Безопасное выполнение внешних процессов
Использование `subprocess.run` с безопасными параметрами:
- `shell=False` для предотвращения выполнения shell-команд
- Проверка возвращаемых кодов
- Обработка таймаутов

## Аутентификация и авторизация

### Учетные данные для RAS
- Используйте отдельного пользователя с минимально необходимыми правами
- Регулярно меняйте пароли
- Не используйте учетные записи администратора для мониторинга

### Принцип наименьших привилегий
- Учетная запись мониторинга должна иметь только права на чтение информации
- Ограничьте права на выполнение операций изменения

## Защита данных

### Логирование
- Логи не должны содержать чувствительную информацию (пароли, токены)
- Используйте уровень логирования ERROR для файлов логов
- Регулярно очищайте логи

### Передача данных
- Данные передаются в формате JSON через stdout
- Не происходит передачи чувствительных данных в ответах

## Безопасность в Zabbix

### Настройка Zabbix Agent
- Ограничьте права пользователя zabbix
- Используйте защищенные соединения между Zabbix Server и Agent
- Проверяйте UserParameter на предмет возможных уязвимостей внедрения

### Пример безопасной настройки UserParameter
```
# Правильно: параметры не передаются напрямую из Zabbix
UserParameter=1c.cluster.status[*],/usr/local/bin/python3 /opt/zbx-1c-py/main.py --check-ras

# НЕБЕЗОПАСНО: может позволить внедрение команд
# UserParameter=1c.custom.command[*],/usr/local/bin/python3 /opt/zbx-1c-py/main.py $1
```

## Кроссплатформенные особенности безопасности

### Windows
- Используйте права доступа NTFS для защиты файлов конфигурации
- Убедитесь, что пользователь Zabbix Agent имеет минимально необходимые права
- Проверьте политики безопасности Windows
- Используйте шифрование EFS для чувствительных файлов при необходимости

### Linux
- Используйте права доступа к файлам (chmod/chown) для защиты конфигурации
- Убедитесь, что пользователь zabbix не имеет избыточных прав
- Проверьте настройки SELinux/AppArmor при наличии
- Используйте sudo только при необходимости с минимальными правами

### macOS
- Используйте права доступа к файлам для защиты конфигурации
- Убедитесь, что пользователь Zabbix Agent имеет минимально необходимые права
- Проверьте настройки Gatekeeper и System Integrity Protection
- Используйте FileVault для шифрования диска при необходимости

## Защита от DoS-атак

### Ограничение ресурсов
- Установлены таймауты для всех внешних вызовов
- Ограничено время выполнения команд
- Проверка на бесконечные циклы

### Примеры таймаутов в коде
```python
# В модуле clusters.py
result = subprocess.run(cmd, capture_output=True, text=False, check=False, timeout=15)

# В модуле session.py
result = subprocess.run(cmd, capture_output=True, check=False, text=False, timeout=20)
```

## Обновления безопасности

### Мониторинг уязвимостей
- Регулярно проверяйте уведомления о безопасности для используемых библиотек
- Подпишитесь на уведомления о безопасности в репозитории
- Используйте инструменты автоматической проверки

### Процесс обновления
1. Проверьте наличие обновлений безопасности
2. Протестируйте обновления в изолированной среде
3. Обновите зависимости в соответствии с политикой безопасности
4. Проверьте работоспособность после обновления

### Безопасность изолированной среды
Проект использует uv для обеспечения изоляции от системного Python, что добавляет дополнительный уровень безопасности:
- Зависимости устанавливаются в изолированное окружение
- Уязвимости в системном Python не влияют на проект
- Контроль версий всех зависимостей через lock-файл
- Проверка уязвимостей с помощью `uv run pip-audit`

## Аудит безопасности

### Регулярные проверки
- Проверка конфигурации на наличие открытых учетных данных
- Проверка прав доступа к файлам и каталогам
- Проверка логов на наличие подозрительной активности

### Контрольные точки аудита
- Проверка наличия файла .env и его содержимого
- Проверка прав доступа к исполняемым файлам
- Проверка настройки логирования
- Проверка настроек Zabbix Agent

## Рекомендации по развертыванию

### Изолированная среда
- Используйте виртуальное окружение для изоляции зависимостей
- Рассмотрите использование контейнеризации (Docker) для дополнительной изоляции
- Используйте отдельные учетные записи для каждого компонента системы

### Мониторинг безопасности
- Настройте мониторинг попыток несанкционированного доступа
- Регулярно просматривайте логи безопасности
- Установите уведомления о подозрительной активности

## Инцидент-респонс

### План действий при инцидентах
1. Оцените масштаб инцидента
2. Изолируйте затронутые системы
3. Проведите расследование
4. Устраните уязвимость
5. Восстановите нормальную работу
6. Документируйте инцидент и уроки

### Контакты для уведомления
- Администраторы безопасности
- Владельцы инфраструктуры 1С
- Администраторы Zabbix

## Совместимость с безопасностью

### Совместимость с политиками безопасности
- Проект соответствует принципам минимальных привилегий
- Не требует прав суперпользователя для нормальной работы
- Поддерживает интеграцию с системами безопасности предприятия

### Проверка соответствия
- Проверьте соответствие внутренним политикам безопасности
- Убедитесь в соответствии требованиям compliance (если применимо)
- Проведите оценку рисков перед развертыванием