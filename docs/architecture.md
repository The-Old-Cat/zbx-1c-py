# Архитектура проекта

## Общая архитектура

Проект zbx-1c-py представляет собой кроссплатформенное модульное приложение на Python, предназначенное для интеграции 1С:Предприятия с системой мониторинга Zabbix. Архитектура проекта построена по принципам модульности, разделения ответственности и легкой расширяемости. Проект работает на Windows, Linux и macOS.

## Диаграмма архитектуры

```
┌─────────────────┐    ┌──────────────────┐    ┌──────────────┐
│   Zabbix       │◄──►│   main.py        │◄──►│  config.py   │
│   (Monitoring)  │    │(Main Application)│    │(Configuration)│
└─────────────────┘    └──────────────────┘    └──────────────┘
                                │
                 ┌────────────────┼────────────────┐
                 │               │                │
        ┌────────▼────────┐ ┌────▼────┐ ┌────────▼────────┐
        │  clusters.py    │ │session.py│ │background_jobs.py│
        │(Cluster Mgmt)   │ │(Session │ │(Job Filtering)  │
        └─────────────────┘ │Mgmt)    │ └─────────────────┘
                           └─────────┘
                                │
                       ┌────────▼────────┐
                       │ session_active.py │
                       │(Active Session   │
                       │Filtering)        │
                       └─────────────────┘
                                │
                       ┌────────▼────────┐
                       │   utils/        │
                       │(Helper Functions)│
                       └─────────────────┘
```

## Структура проекта

```
src/
└── zbx_1c_py/
    ├── __init__.py          # Инициализация пакета
    ├── main.py             # Главная точка входа
    ├── config.py           # Управление конфигурацией
    ├── clusters.py         # Управление кластерами 1С
    ├── session.py          # Управление сессиями
    ├── session_active.py   # Фильтрация активных сессий
    ├── background_jobs.py  # Фильтрация фоновых заданий
    ├── utils/
    │   ├── helpers.py      # Вспомогательные функции
    │   └── check_config.py # Проверка конфигурации
```

## Компоненты системы

### 1. main.py - Главный модуль
**Ответственность**:
- Точка входа в приложение
- Обработка аргументов командной строки
- Организация взаимодействия между компонентами
- Формирование ответов для Zabbix

**Основные функции**:
- `get_discovery_json()` - генерация JSON для LLD
- `collect_metrics_for_cluster()` - сбор метрик для кластера
- `main()` - основная логика приложения

**Режимы работы**:
- `--discovery`: возврат списка кластеров
- `--check-ras`: проверка доступности RAS
- `<cluster_id>`: сбор метрик для кластера

### 2. config.py - Модуль конфигурации
**Ответственность**:
- Управление настройками приложения
- Загрузка параметров из .env и переменных окружения
- Валидация параметров подключения

**Ключевые элементы**:
- `Settings` - класс конфигурации на основе Pydantic
- `settings` - глобальный экземпляр настроек
- Поддержка типизации и валидации параметров

### 3. clusters.py - Управление кластерами
**Ответственность**:
- Получение информации о кластерах 1С
- Проверка доступности RAS-сервиса
- Извлечение идентификаторов кластеров

**Основные функции**:
- `check_ras_availability()` - проверка доступности RAS
- `get_all_clusters()` - получение всех кластеров
- `get_cluster_ids()` - извлечение ID кластеров
- `initialize_cluster_info()` - инициализация глобальных данных

### 4. session.py - Управление сессиями
**Ответственность**:
- Получение информации о сессиях пользователей
- Формирование команд для взаимодействия с RAS
- Безопасное выполнение внешних процессов

**Основные функции**:
- `get_session_command()` - формирование команды для rac
- `fetch_raw_sessions()` - получение "сырых" данных о сессиях
- `get_active_sessions_report()` - формирование отчета об активных сессиях

### 5. session_active.py - Фильтрация активных сессий
**Ответственность**:
- Определение активных сессий на основе бизнес-логики
- Проверка статуса спящего режима
- Анализ времени последней активности
- Проверка фактической активности (вызовы, трафик)

**Основные функции**:
- `is_session_active()` - проверка активности сессии
- `filter_active_sessions()` - фильтрация списка сессий
- `get_session_summary()` - формирование описания сессии

### 6. background_jobs.py - Фильтрация фоновых заданий
**Ответственность**:
- Определение активных фоновых заданий
- Проверка состояния выполнения заданий
- Ограничение по длительности выполнения
- Обнаружение "зависших" заданий

**Основные функции**:
- `is_background_job_active()` - проверка активности задания
- `filter_active_background_jobs()` - фильтрация списка заданий
- `get_background_job_summary()` - формирование описания задания

### 7. utils/helpers.py - Вспомогательные утилиты
**Ответственность**:
- Универсальные функции для обработки данных
- Парсинг вывода утилиты rac
- Декодирование бинарных данных

**Основные функции**:
- `universal_filter()` - универсальный фильтр для списков словарей
- `parse_rac_output()` - парсинг вывода rac
- `decode_output()` - декодирование бинарных данных

## Кроссплатформенные аспекты архитектуры

### 1. Утилита rac
Проект взаимодействует с различными версиями утилиты rac в зависимости от операционной системы:
- **Windows**: `rac.exe`
- **Linux**: `rac`
- **macOS**: `rac`

### 2. Обработка путей
Архитектура учитывает различия в системах файлов:
- **Windows**: поддержка как прямых `/`, так и обратных `\` разделителей
- **Linux/macOS**: использование прямых `/` разделителей

### 3. Кодировка данных
Модуль `utils.helpers.py` реализует обработку различных кодировок:
- **Windows**: по умолчанию используется CP866 для 1С
- **Linux/macOS**: обычно используется UTF-8
- Автоматическое определение и декодирование данных

### 4. Выполнение внешних процессов
Модуль `subprocess` используется с учетом особенностей каждой ОС:
- Безопасные параметры выполнения
- Обработка таймаутов
- Правильная обработка возвращаемых кодов

## Потоки данных

### Поток получения информации о кластерах
```
main.py → clusters.py → subprocess.run(rac cluster list) → parse_rac_output → main.py
```

### Поток получения информации о сессиях
```
main.py → session.py → subprocess.run(rac session list) → parse_rac_output → 
session_active.py → filter_active_sessions → main.py
```

### Поток получения информации о фоновых заданиях
```
main.py → main.fetch_background_jobs_raw → subprocess.run(rac background-job list) → 
parse_rac_output → background_jobs.py → filter_active_background_jobs → main.py
```

## Паттерны проектирования

### 1. Singleton (настройки)
Класс `Settings` из config.py реализует паттерн Singleton через глобальный экземпляр `settings`.

### 2. Фасад (main.py)
Модуль main.py выступает в роли фасада, предоставляя унифицированный интерфейс для взаимодействия с другими модулями.

### 3. Стратегия (фильтрация)
Функции фильтрации (session_active.py, background_jobs.py) реализуют паттерн стратегия для определения активности.

### 4. Утилиты (utils/helpers.py)
Модуль utils.helpers.py содержит набор независимых функций, реализующих паттерн утилит.

## Принципы проектирования

### 1. Принцип единственной ответственности (SRP)
Каждый модуль имеет одну четко определенную ответственность:
- config.py - только управление конфигурацией
- clusters.py - только работа с кластерами
- session.py - только работа с сессиями

### 2. Принцип открытости/закрытости (OCP)
Архитектура позволяет расширять функциональность без изменения существующего кода:
- Новые типы фильтров могут быть добавлены в отдельных модулях
- Новые метрики могут быть добавлены в существующие функции

### 3. Принцип инверсии зависимостей (DIP)
Модули зависят от абстракций (интерфейсов), а не от конкретных реализаций:
- Модули используют настройки через абстракцию Settings
- Функции принимают данные в универсальном формате

## Безопасность архитектуры

### 1. Изоляция секретов
Конфиденциальные данные (учетные данные) изолированы в модуле config.py и не передаются в другие модули напрямую.

### 2. Безопасное выполнение процессов
Все вызовы subprocess.run используют безопасные параметры для предотвращения внедрения команд.

### 3. Валидация входных данных
Все внешние параметры проходят проверку и валидацию перед использованием.

## Изоляция среды выполнения

### 1. Управление зависимостями через uv
Архитектура проекта предусматривает полную изоляцию от системного Python через использование uv:
- Все зависимости устанавливаются в изолированное окружение
- Версии пакетов фиксируются в lock-файле
- Запуск осуществляется через uv run для обеспечения изоляции

### 2. Управление версиями Python
- Проект может использовать конкретную версию Python независимо от системной
- Поддержка различных версий Python через uv python install

## Масштабируемость

### 1. Поддержка нескольких кластеров
Архитектура позволяет работать с несколькими кластерами 1С одновременно.

### 2. Автоматическое обнаружение
Реализована поддержка LLD (Low-Level Discovery) для автоматического обнаружения новых кластеров.

### 3. Независимость кластеров
Каждый кластер обрабатывается независимо, что позволяет масштабировать систему.

## Интеграция с Zabbix

### 1. Master/Dependent Items
Архитектура поддерживает схему Master/Dependent Items для эффективного сбора метрик.

### 2. JSON-ответы
Все ответы формируются в формате JSON, подходящем для обработки Zabbix.

### 3. LLD-поддержка
Реализована поддержка Low-Level Discovery для автоматического создания элементов данных.