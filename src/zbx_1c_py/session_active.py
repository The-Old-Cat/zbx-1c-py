"""
Модуль для фильтрации активных сессий 1С:Предприятия.

Содержит логику определения «активной» сессии на основе:
1. Статуса спящего режима (поле 'hibernate')
2. Времени последней активности (поле 'last-active-at')
3. Фактической активности за последние 5 минут (поля 'calls-last-5min', 'bytes-last-5min')

⚠️ ВАЖНО: Активная сессия ≠ просто «открытая» сессия.
Активная сессия — это сессия, с которой пользователь реально взаимодействует
в данный момент (последние 5 минут).
"""

from datetime import datetime, timedelta
from typing import List, Dict, Any


# ============================================================================
# ОСНОВНЫЕ ФУНКЦИИ
# ============================================================================


def is_session_active(session: Dict[str, Any], threshold_minutes: int = 5) -> bool:
    """
    Определяет, является ли сессия 1С активной (пользователь реально работает).

    Активная сессия должна соответствовать ВСЕМ критериям:
    ✅ 1. Не находится в спящем режиме (hibernate == 'no')
    ✅ 2. Последняя активность была менее `threshold_minutes` минут назад
    ✅ 3. Есть фактическая активность за последние 5 минут (вызовы ИЛИ трафик > 0)

    Почему все три критерия?
    -------------------------
    • Сессия может быть 'не в спящем режиме', но бездействовать часами
      (например, открыто окно 1С, но пользователь ушёл обедать).
    • Время 'last-active-at' может быть свежим из-за фоновых операций,
      но пользователь не взаимодействует с интерфейсом.
    • Комбинация всех трёх критериев даёт точное определение «реальной» активности.

    Параметры:
        session (Dict[str, Any]): Словарь с данными одной сессии
                                  из вывода `rac session list`.
                                  Обязательные поля: 'hibernate', 'last-active-at'.
                                  Рекомендуемые поля: 'calls-last-5min', 'bytes-last-5min'.
        threshold_minutes (int): Порог активности в минутах. По умолчанию 5 минут.

    Возвращает:
        bool: True — сессия активна, False — сессия неактивна или некорректна.

    Примеры использования:
        >>> session = {
        ...     'hibernate': 'no',
        ...     'last-active-at': '2026-02-11T10:06:04',
        ...     'calls-last-5min': '36',
        ...     'bytes-last-5min': '103675'
        ... }
        >>> is_session_active(session)
        True

        >>> session = {
        ...     'hibernate': 'yes',  # ← в спящем режиме
        ...     'last-active-at': '2026-02-10T15:56:51',
        ...     'calls-last-5min': '0'
        ... }
        >>> is_session_active(session)
        False

    Примечания:
        • Если поля 'calls-last-5min' или 'bytes-last-5min' отсутствуют или некорректны,
          функция пропускает проверку по трафику и полагается только на первые два критерия.
        • Временные зоны: функция корректно обрабатывает ISO-строки с и без указания временной зоны.
    """
    # -------------------------------------------------------------------------
    # КРИТЕРИЙ 1: Проверка спящего режима
    # -------------------------------------------------------------------------
    # Поле 'hibernate' показывает, переведена ли сессия сервером в энергосберегающий режим.
    # • 'no' — сессия активна (не в спящем режиме)
    # • 'yes' — сессия приостановлена из-за бездействия > 20 минут (по умолчанию)
    #
    # ⚠️ Даже если 'last-active-at' свежий, но 'hibernate' = 'yes' —
    #    сессия НЕ считается активной (сервер её "усыпил").
    if session.get("hibernate") != "no":
        return False

    # -------------------------------------------------------------------------
    # КРИТЕРИЙ 2: Проверка времени последней активности
    # -------------------------------------------------------------------------
    # Сравниваем 'last-active-at' с текущим временем минус порог (по умолчанию 5 минут).
    try:
        # Преобразуем ISO-строку в объект datetime
        # Примеры входных строк:
        #   '2026-02-11T10:06:04'        → naive datetime (без временной зоны)
        #   '2026-02-11T10:06:04Z'       → UTC (заменяем 'Z' на '+00:00')
        #   '2026-02-11T10:06:04+03:00'  → с указанием временной зоны
        last_active_str = session["last-active-at"].replace("Z", "+00:00")
        last_active = datetime.fromisoformat(last_active_str)

        # Определяем текущее время в той же временной зоне, что и last_active
        # • Если last_active имеет временную зону (tzinfo) — используем её
        # • Иначе — работаем с локальным временем (naive datetime)
        if last_active.tzinfo:
            now = datetime.now(last_active.tzinfo)
        else:
            now = datetime.now()

        # Проверяем, что последняя активность была позже, чем (сейчас - порог)
        if last_active < now - timedelta(minutes=threshold_minutes):
            return False

    except (ValueError, KeyError, TypeError) as e:
        # Обработка ошибок:
        # • ValueError — некорректный формат даты
        # • KeyError — отсутствует поле 'last-active-at'
        # • TypeError — значение не является строкой
        #
        # В случае ошибки считаем сессию НЕАКТИВНОЙ (защита от некорректных данных)
        return False

    # -------------------------------------------------------------------------
    # КРИТЕРИЙ 3: Проверка фактической активности за последние 5 минут
    # -------------------------------------------------------------------------
    # Даже если сессия не в спящем режиме и время активности свежее,
    # пользователь может не взаимодействовать с системой (просто открыто окно).
    #
    # Проверяем два индикатора реальной активности:
    #   • calls-last-5min — количество вызовов сервера за последние 5 минут
    #   • bytes-last-5min — объём переданных данных за последние 5 минут
    #
    # Если ОБА значения = 0 → сессия бездействует → НЕ активна.
    try:
        calls = int(session.get("calls-last-5min", "0"))
        bytes_ = int(session.get("bytes-last-5min", "0"))

        # Если нет вызовов И нет трафика — сессия простаивает
        if calls == 0 and bytes_ == 0:
            return False

    except (ValueError, TypeError):
        # Если поля отсутствуют или имеют некорректный формат —
        # пропускаем эту проверку и полагаемся на первые два критерия.
        # Это допустимо для старых версий 1С или специфичных конфигураций.
        pass

    # -------------------------------------------------------------------------
    # ИТОГ: Все критерии пройдены → сессия активна
    # -------------------------------------------------------------------------
    return True


def filter_active_sessions(
    sessions: List[Dict[str, Any]], threshold_minutes: int = 5
) -> List[Dict[str, Any]]:
    """
    Фильтрует список сессий, оставляя только активные.

    Параметры:
        sessions (List[Dict[str, Any]]): Список словарей с данными сессий.
                                         Каждый словарь должен содержать поля,
                                         ожидаемые функцией is_session_active().
        threshold_minutes (int): Порог активности в минутах. По умолчанию 5.

    Возвращает:
        List[Dict[str, Any]]: Список активных сессий (фильтрованная копия входного списка).

    Пример использования:
        >>> all_sessions = parse_rac_output(rac_stdout)
        >>> active = filter_active_sessions(all_sessions, threshold_minutes=5)
        >>> print(f"Активных сессий: {len(active)}")
        Активных сессий: 3

    Примечания:
        • Возвращает НОВЫЙ список — исходный список не модифицируется.
        • Пустой входной список → пустой результат (без ошибок).
        • Для каждой сессии вызывается is_session_active().
    """
    return [
        s  # 's' — стандартное имя для элемента в итерации (избегает конфликтов с 'session')
        for s in sessions
        if is_session_active(s, threshold_minutes=threshold_minutes)
    ]


# ============================================================================
# ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ
# ============================================================================


def get_session_summary(session: Dict[str, Any]) -> str:
    """
    Формирует краткое текстовое описание сессии для логирования или вывода.

    Параметры:
        session (Dict[str, Any]): Словарь с данными сессии.

    Возвращает:
        str: Строка вида "User: Иванов И.И. | App: 1CV8C | Last: 10:06:04 | Calls: 36"

    Пример:
        >>> session = {
        ...     'user-name': 'Иванов Иван Иванович',
        ...     'app-id': '1CV8C',
        ...     'last-active-at': '2026-02-11T10:06:04',
        ...     'calls-last-5min': '36'
        ... }
        >>> get_session_summary(session)
        'User: Иванов И.И.     | App: 1CV8C   | Last: 10:06:04 | Calls: 36'
    """
    user = session.get("user-name", "N/A")
    # Сокращаем ФИО для компактности: "Иванов Иван Иванович" → "Иванов И.И."
    if " " in user:
        parts = user.split()
        if len(parts) >= 3:
            user = f"{parts[0]} {parts[1][0]}.{parts[2][0]}."

    app = session.get("app-id", "N/A")
    last_active = (
        session.get("last-active-at", "N/A").split("T")[-1][:8]
        if "T" in session.get("last-active-at", "")
        else session.get("last-active-at", "N/A")
    )
    calls = session.get("calls-last-5min", "N/A")

    return f"User: {user:20} | App: {app:8} | Last: {last_active} | Calls: {calls}"


# ============================================================================
# ТЕСТОВЫЙ БЛОК (для самостоятельной проверки модуля)
# ============================================================================

if __name__ == "__main__":
    # Пример данных для тестирования (имитация вывода rac session list)
    test_sessions = [  # ← ИМЯ БЕЗ 'session' В КОРНЕ (избегаем глобальной переменной 'session')
        {
            "hibernate": "no",
            "last-active-at": "2026-02-11T10:06:04",
            "calls-last-5min": "36",
            "bytes-last-5min": "103675",
            "user-name": "Иванов Иван Иванович",
            "app-id": "1CV8C",
        },
        {
            "hibernate": "yes",  # ← спящий режим
            "last-active-at": "2026-02-10T15:56:51",
            "calls-last-5min": "0",
            "user-name": "Пользователь2",
            "app-id": "1CV8",
        },
        {
            "hibernate": "no",
            "last-active-at": "2026-02-11T10:06:54",
            "calls-last-5min": "0",  # ← нет вызовов
            "bytes-last-5min": "0",  # ← нет трафика
            "user-name": "Пользователь3",
            "app-id": "Designer",
        },
    ]

    print("Тест фильтрации активных сессий:")
    print("=" * 70)

    active = filter_active_sessions(test_sessions)

    print(f"\nВсего сессий: {len(test_sessions)}")
    print(f"Активных сессий: {len(active)}\n")

    # Используем 's' вместо 'session' в цикле (избегаем переопределения параметра функции)
    for i, s in enumerate(active, 1):
        print(f"{i}. {get_session_summary(s)}")

    print("\n" + "=" * 70)
    print("✅ Тест завершён. Модуль готов к использованию.")
